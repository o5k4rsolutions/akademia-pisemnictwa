<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akademia Pisemnictwa - Klub Plik贸w</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .hero-bg { background-image: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-primary { transition: all 0.2s; }
        .btn-primary:hover { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .input-field:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Loader / Komunikat -->
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loading-text">adowanie...</span>
            </div>
        </div>

        <!-- Nag贸wek i Nawigacja -->
        <header class="bg-white shadow-md">
            <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
                <a href="#" onclick="navigateTo('home')" class="text-2xl font-bold text-emerald-600">Akademia Pisemnictwa</a>
                <div class="flex items-center space-x-4">
                    <span id="user-display" class="hidden text-gray-700 text-sm font-medium"></span>
                    <button id="auth-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out" onclick="handleAuthClick()">
                        Zaloguj si
                    </button>
                </div>
            </nav>
        </header>

        <!-- G贸wna Zawarto -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <div id="view-container">
                <!-- Widoki bd renderowane tutaj przez JavaScript -->
            </div>
        </main>

        <!-- Stopka -->
        <footer class="bg-gray-800 text-white py-4 text-center">
            <p class="text-sm">&copy; 2024 Akademia Pisemnictwa. Wszelkie prawa zastrze偶one.</p>
        </footer>
    </div>

    <!-- Skrypty Firebase i Logika Aplikacji -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('debug'); // Odkomentuj do debugowania

        // --- GLOBALNE ZMIENNE RODOWISKOWE (OBOWIZKOWE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const FORMSPREE_URL = 'https://formspree.io/f/mkgkwena';

        // --- STAN APLIKACJI ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let userProfile = null; // Przechowuje dane profilu z Firestore
        let currentView = 'home'; // home, auth, verificationPending, filesClub

        // --- ELEMENTY DOM ---
        const viewContainer = document.getElementById('view-container');
        const authButton = document.getElementById('auth-button');
        const userDisplay = document.getElementById('user-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // Funkcja do pokazywania/ukrywania loadera
        const setLoading = (show, text = 'adowanie...') => {
            loadingText.textContent = text;
            loadingOverlay.classList.toggle('hidden', !show);
        };

        // --- FIREBASE SETUP & AUTH ---

        const getUserProfileRef = (uid) => {
             // cie偶ka do prywatnego profilu: /artifacts/{appId}/users/{uid}/academy_profiles/data
            return doc(db, `artifacts/${appId}/users/${uid}/academy_profiles/data`);
        }

        const setupFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Obsuga pocztkowego uwierzytelnienia z Canvas
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Nasuchiwanie zmian stanu uwierzytelnienia
                onAuthStateChanged(auth, (user) => {
                    userId = user ? user.uid : null;
                    isAuthReady = true;
                    // Jeli u偶ytkownik jest zalogowany (nie anonimowo, bo ma email/haso), spr贸buj pobra profil
                    if (user && user.email) {
                        listenToUserProfile(user.uid);
                    } else {
                        // Jeli wylogowany lub anonimowy, resetuj widok i profil
                        userProfile = null;
                        updateAuthUI(user);
                        if (currentView !== 'home') {
                            navigateTo('home');
                        }
                    }
                });

            } catch (error) {
                console.error("Bd inicjalizacji Firebase:", error);
                setLoading(false);
                alertMessage(`Bd inicjalizacji: ${error.message}. Sprawd藕 konfiguracj Firebase.`);
            }
        };

        // Nasuchiwanie zmian w profilu u偶ytkownika (status weryfikacji)
        const listenToUserProfile = (uid) => {
            const profileRef = getUserProfileRef(uid);
            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    console.log("Pobrano profil:", userProfile);
                    checkVerificationStatus();
                } else {
                    userProfile = null;
                    // Jeli u偶ytkownik jest zalogowany, ale nie ma profilu (prawdopodobnie anonimowy lub problem),
                    // cofamy do strony g贸wnej.
                    if (auth.currentUser && !auth.currentUser.isAnonymous) {
                         // To mo偶e si zdarzy, gdy zarejestrowany u偶ytkownik usunie swoje dane z Firestore
                    } else {
                        navigateTo('home');
                    }
                }
                updateAuthUI(auth.currentUser);
                setLoading(false);
            }, (error) => {
                console.error("Bd nasuchiwania Firestore:", error);
                setLoading(false);
            });
        };

        // Weryfikacja statusu i nawigacja po zalogowaniu
        const checkVerificationStatus = () => {
            if (!auth.currentUser) {
                navigateTo('home');
                return;
            }

            if (userProfile && userProfile.verificationStatus === 'verified') {
                navigateTo('filesClub');
            } else if (userProfile && userProfile.verificationStatus === 'pending') {
                navigateTo('verificationPending');
            } else {
                // To si zdarza, gdy u偶ytkownik zalogowa si, ale nie przeszed rejestracji (np. testowo)
                navigateTo('home');
            }
        };

        // --- OBSUGA UI I NAWIGACJA ---

        // Aktualizacja przycisku logowania/wylogowania
        const updateAuthUI = (user) => {
            if (user && userProfile) {
                authButton.textContent = 'Wyloguj';
                authButton.onclick = signOutUser;
                userDisplay.textContent = `Witaj, ${userProfile.fullName.split(' ')[0]}!`;
                userDisplay.classList.remove('hidden');
            } else {
                authButton.textContent = 'Zaloguj si';
                authButton.onclick = () => navigateTo('auth');
                userDisplay.classList.add('hidden');
                userDisplay.textContent = '';
            }
        };

        const handleAuthClick = () => {
            if (auth.currentUser && userProfile) {
                signOutUser();
            } else {
                navigateTo('auth');
            }
        };
        
        // Funkcja do wywietlania komunikat贸w (zamiast alert())
        const alertMessage = (message) => {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl z-[999] opacity-0 transition-opacity duration-300';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.classList.add('opacity-100'); }, 10);
            setTimeout(() => { notification.classList.remove('opacity-100'); }, 4000);
            setTimeout(() => { notification.remove(); }, 5000);
        };


        // G贸wna funkcja nawigacji
        window.navigateTo = (view) => {
            currentView = view;
            render();
            // Przewi do g贸ry po zmianie widoku
            window.scrollTo(0, 0);
        };
        
        // --- WIDOKI ---

        const renderHomeView = () => `
            <div class="hero-bg text-white p-12 md:p-20 rounded-xl shadow-2xl text-center">
                <h1 class="text-4xl md:text-6xl font-extrabold mb-4">Akademia Pisemnictwa</h1>
                <p class="text-xl md:text-2xl mb-8 font-light">Twoje 藕r贸do profesjonalnych materia贸w do nauki pisania wypracowa.</p>
                <button onclick="navigateTo('auth')" class="bg-white text-emerald-600 font-bold py-3 px-8 rounded-full text-lg uppercase tracking-wider btn-primary">
                    Docz do Klubu Plik贸w
                </button>
            </div>

            <div class="grid md:grid-cols-3 gap-8 mt-12">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-500">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Baza Wypracowa</h3>
                    <p class="text-gray-600">Gotowe szablony i analizy lektur, dostosowane do wymaga egzaminacyjnych.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-500">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Checklisty Oceniania</h3>
                    <p class="text-gray-600">Dokadne listy kontrolne dla nauczycieli i uczni贸w, uatwiajce sprawdzanie prac.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-500">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Webinary i Kursy</h3>
                    <p class="text-gray-600">Dostp do archiwalnych nagra z warsztat贸w dla polonist贸w.</p>
                </div>
            </div>
        `;

        const renderAuthView = (isRegister = false) => `
            <div id="auth-card" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">${isRegister ? 'Zarejestruj si' : 'Zaloguj si'}</h2>
                <form id="auth-form">
                    ${isRegister ? `
                        <input type="text" id="fullName" placeholder="Imi i nazwisko" required class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="email" id="email" placeholder="E-mail" required class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="tel" id="phone" placeholder="Numer telefonu (opcjonalnie)" class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="password" id="password" placeholder="Haso" required class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="password" id="confirmPassword" placeholder="Powt贸rz haso" required class="input-field w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none"/>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg btn-primary shadow-md">
                            Zarejestruj i Popro o Weryfikacj
                        </button>
                    ` : `
                        <input type="email" id="loginEmail" placeholder="E-mail" required class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="password" id="loginPassword" placeholder="Haso" required class="input-field w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none"/>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg btn-primary shadow-md">
                            Zaloguj si
                        </button>
                    `}
                </form>
                <div class="mt-6 text-center">
                    ${isRegister ? `
                        <p class="text-sm text-gray-600">Masz ju偶 konto? <a href="#" onclick="switchAuthMode(false)" class="text-emerald-600 hover:text-emerald-700 font-semibold">Zaloguj si</a></p>
                    ` : `
                        <p class="text-sm text-gray-600">Nie masz konta? <a href="#" onclick="switchAuthMode(true)" class="text-emerald-600 hover:text-emerald-700 font-semibold">Zarejestruj si</a></p>
                    `}
                </div>
            </div>
        `;

        const renderVerificationPendingView = () => `
            <div class="max-w-xl mx-auto bg-yellow-50 p-10 rounded-xl shadow-2xl border-l-4 border-yellow-500 text-center">
                <svg class="w-16 h-16 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h2 class="text-3xl font-bold mb-4 text-gray-800">Trwa weryfikacja konta</h2>
                <p class="text-gray-600 mb-6 text-lg">Dzikujemy za rejestracj, ${userProfile ? userProfile.fullName.split(' ')[0] : 'U偶ytkowniku'}!</p>
                <p class="text-gray-700 font-medium">Weryfikacja portwa do **5 dni roboczych**. O pozytywnej weryfikacji otrzymasz maila. Po weryfikacji automatycznie uzyskasz dostp do Klubu Plik贸w.</p>
                <button onclick="signOutUser()" class="mt-8 text-sm text-red-500 hover:text-red-700 transition">Wyloguj i wr贸 p贸藕niej</button>
            </div>
        `;

        const renderFilesClubView = () => `
            <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-emerald-600">
                <h2 class="text-4xl font-bold mb-6 text-emerald-700"> Klub Plik贸w - Strefa Premium</h2>
                <p class="text-lg text-gray-700 mb-8">Witaj w miejscu, gdzie znajdziesz sprawdzone, gotowe do u偶ycia materiay. Dostp tylko dla zweryfikowanych czonk贸w.</p>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Materia 1 -->
                    <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 hover:shadow-md transition duration-150">
                        <h3 class="text-2xl font-semibold mb-2 text-gray-800">Egzamin smoklasisty: Analiza Lektur</h3>
                        <p class="text-gray-600">Szczeg贸owe streszczenia, motywy i gotowe tezy do najczciej spotykanych lektur. Format PDF.</p>
                        <a href="#" class="mt-3 inline-block text-emerald-600 font-medium hover:underline">Pobierz plik PDF (2.5 MB)</a>
                    </div>
                    <!-- Materia 2 -->
                    <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 hover:shadow-md transition duration-150">
                        <h3 class="text-2xl font-semibold mb-2 text-gray-800">10 Szablon贸w Wypracowa Wnioskujcych</h3>
                        <p class="text-gray-600">Struktury logiczne do tworzenia przekonujcych argument贸w. Plik DOCX/ODT.</p>
                        <a href="#" class="mt-3 inline-block text-emerald-600 font-medium hover:underline">Pobierz plik DOCX (0.8 MB)</a>
                    </div>
                    <!-- Materia 3 -->
                    <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 hover:shadow-md transition duration-150">
                        <h3 class="text-2xl font-semibold mb-2 text-gray-800">Checklista do Oceny Eseju</h3>
                        <p class="text-gray-600">Kompleksowa lista kryteri贸w oceniania dla nauczycieli i samooceny dla uczni贸w.</p>
                        <a href="#" class="mt-3 inline-block text-emerald-600 font-medium hover:underline">Otw贸rz Arkusz Google</a>
                    </div>
                     <!-- Materia 4 -->
                    <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 hover:shadow-md transition duration-150">
                        <h3 class="text-2xl font-semibold mb-2 text-gray-800">Wideo: Jak Pisa Wstp?</h3>
                        <p class="text-gray-600">Nagranie wideo z kursu o skutecznym i anga偶ujcym wstpie do ka偶dej pracy pisemnej.</p>
                        <a href="#" class="mt-3 inline-block text-emerald-600 font-medium hover:underline">Obejrzyj Wideo</a>
                    </div>
                </div>
            </div>
        `;


        const render = () => {
            let htmlContent;
            switch (currentView) {
                case 'home':
                    htmlContent = renderHomeView();
                    break;
                case 'auth':
                    // Domylnie poka偶 widok logowania, ale pozw贸l na przeczenie
                    htmlContent = renderAuthView(false); 
                    break;
                case 'verificationPending':
                    htmlContent = renderVerificationPendingView();
                    break;
                case 'filesClub':
                    if (userProfile && userProfile.verificationStatus === 'verified') {
                        htmlContent = renderFilesClubView();
                    } else {
                        // Ochrona dostpu
                        htmlContent = renderHomeView();
                        navigateTo('home');
                    }
                    break;
                default:
                    htmlContent = renderHomeView();
            }
            viewContainer.innerHTML = htmlContent;
            
            // Po wyrenderowaniu widoku Auth, doczamy listener do formularza
            if (currentView === 'auth') {
                document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
            }
        };

        window.switchAuthMode = (isRegister) => {
            const authCard = document.getElementById('auth-card');
            authCard.innerHTML = renderAuthView(isRegister).match(/<form[\s\S]*<\/div>/)[0];
            document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
        };

        // --- OBSUGA FORMULARZY ---

        const handleAuthFormSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            
            if (form.querySelector('#fullName')) {
                // Tryb Rejestracji
                const fullName = form.querySelector('#fullName').value.trim();
                const email = form.querySelector('#email').value.trim();
                const phone = form.querySelector('#phone').value.trim();
                const password = form.querySelector('#password').value;
                const confirmPassword = form.querySelector('#confirmPassword').value;

                if (password.length < 6) {
                    alertMessage('Haso musi mie co najmniej 6 znak贸w.');
                    return;
                }
                if (password !== confirmPassword) {
                    alertMessage('Hasa nie s identyczne!');
                    return;
                }
                
                // Uruchomienie rejestracji
                await registerUser({ fullName, email, phone, password });

            } else {
                // Tryb Logowania
                const email = form.querySelector('#loginEmail').value.trim();
                const password = form.querySelector('#loginPassword').value;
                
                await loginUser(email, password);
            }
        };

        const sendFormspreeNotification = async (userData) => {
            setLoading(true, "Wysyanie powiadomienia...");
            try {
                const response = await fetch(FORMSPREE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        'Weryfikacja': 'NOWA REJESTRACJA WYMAGAJCA WERYFIKACJI',
                        'Imi i Nazwisko': userData.fullName,
                        'Email': userData.email,
                        'Numer Telefonu': userData.phone || 'Brak',
                        'Data Rejestracji': new Date().toLocaleString('pl-PL'),
                        'Status': 'PENDING'
                    })
                });

                if (response.ok) {
                    console.log("Powiadomienie Formspree wysane pomylnie.");
                } else {
                    console.error("Bd wysyania Formspree:", response.statusText);
                }
            } catch (error) {
                console.error("Bd sieci Formspree:", error);
            } finally {
                setLoading(false);
            }
        };

        // --- LOGIKA AUTENTYKACJI I FIREBASE ---

        const registerUser = async (data) => {
            setLoading(true, "Tworzenie konta...");
            
            try {
                // 1. Rejestracja w Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, data.email, data.password);
                const uid = userCredential.user.uid;

                // 2. Zapis danych w Firestore
                const userData = {
                    fullName: data.fullName,
                    email: data.email,
                    phoneNumber: data.phone || null,
                    registrationDate: new Date().toISOString(),
                    verificationStatus: 'pending' // Domylny status
                };
                
                await setDoc(getUserProfileRef(uid), userData);

                // 3. Wysyka do Formspree (asynchronicznie)
                await sendFormspreeNotification(userData);

                // 4. Nawigacja do widoku oczekiwania
                setLoading(false);
                navigateTo('verificationPending');

            } catch (error) {
                setLoading(false);
                let errorMessage = 'Wystpi nieznany bd podczas rejestracji.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Ten adres e-mail jest ju偶 zarejestrowany.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Haso jest za sabe. U偶yj co najmniej 6 znak贸w.';
                } else {
                    console.error("Bd rejestracji:", error);
                    errorMessage = `Bd Firebase: ${error.message}`;
                }
                alertMessage(errorMessage);
                // Wylogowujemy na wypadek, gdyby Auth si udao, a Firestore nie
                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                     await signOut(auth);
                }
            }
        };

        const loginUser = async (email, password) => {
            setLoading(true, "Logowanie...");
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Po zalogowaniu, onAuthStateChanged + listenToUserProfile zajm si reszt
                // i nawigacj do waciwego widoku.
            
            } catch (error) {
                setLoading(false);
                console.error("Bd logowania:", error);
                let errorMessage = 'Bd logowania. Sprawd藕 e-mail i haso.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Nieprawidowy adres e-mail lub haso.';
                }
                alertMessage(errorMessage);
            }
        };

        window.signOutUser = async () => {
            setLoading(true, "Wylogowywanie...");
            try {
                await signOut(auth);
                userProfile = null;
                // navigateTo('home') jest wywoywane przez onAuthStateChanged
            } catch (error) {
                console.error("Bd wylogowania:", error);
                alertMessage(`Bd wylogowania: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };


        // --- START APLIKACJI ---
        window.onload = setupFirebase;

    </script>
</body>
</html>
