<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akademia Pisemnictwa - Klub Plik√≥w</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .hero-bg { background-image: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-primary { transition: all 0.2s; }
        .btn-primary:hover { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .input-field:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); }
        
        #view-container { 
            transition: opacity 0.6s ease-out, transform 0.6s ease-out; 
            transform: perspective(1000px) translateY(0) scale(1);
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Overlay ≈Çadowania -->
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loading-text">≈Åadowanie...</span>
            </div>
        </div>

        <!-- Nag≈Ç√≥wek -->
        <header class="bg-white shadow-md">
            <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
                <a href="#" onclick="navigateTo('home')" class="text-2xl font-bold text-emerald-600">Akademia Pisemnictwa</a>
                <div class="flex items-center space-x-4">
                    <a href="#" id="dashboard-link" onclick="navigateTo('dashboard')" class="text-gray-700 hover:text-emerald-600 font-medium hidden">Panel G≈Ç√≥wny</a>
                    <a href="#" id="files-link" onclick="checkVerificationStatus(true)" class="text-gray-700 hover:text-emerald-600 font-medium hidden">Klub Nauczyciela</a>

                    <span id="user-display" class="hidden text-gray-700 text-sm font-medium"></span>
                    <button id="auth-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out" onclick="handleAuthClick()">
                        Zaloguj siƒô
                    </button>
                </div>
            </nav>
        </header>

        <!-- G≈Ç√≥wna zawarto≈õƒá -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <div id="view-container">
            </div>
        </main>

        <!-- Stopka -->
        <footer class="bg-gray-800 text-white py-4 text-center">
            <p class="text-sm">&copy; 2024 Akademia Pisemnictwa. Wszelkie prawa zastrze≈ºone.</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // DODANO: collection, query, addDoc do operacji na materia≈Çach publicznych
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- ZMIENNE GLOBALNE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDrp3PAn31CvEeNNjEdRo_5oxpmIeL8T5Q",
            authDomain: "akademia-pisemnictwa.firebaseapp.com",
            projectId: "akademia-pisemnictwa",
            storageBucket: "akademia-pisemnictwa.firebasestorage.app",
            messagingSenderId: "743127115663",
            appId: "1:743127115663:web:4e89d5bcc1b00c8eef0dfa",
            measurementId: "G-4K3TK9XLLR"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Formspree URL dla powiadomienia do ADMINISTRATORA (o nowƒÖ rejestracjƒô)
        const FORMSPREE_ADMIN_NOTIFICATION_URL = 'https://formspree.io/f/mkgkwena'; 

        // Formspree URL dla wiadomo≈õci powitalnej do U≈ªYTKOWNIKA
        // UWAGA: ZastƒÖp ten link swoim w≈Çasnym, dedykowanym do wiadomo≈õci powitalnej
        const FORMSPREE_WELCOME_URL = 'https://formspree.io/f/mknenrno'; 

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let userProfile = null;
        let currentView = 'home';
        let selectedClass = 4; // Filtr klasy dla Klubu Nauczyciela

        let materialState = {
            allMaterials: [], // Zastƒôpuje hardkodowanƒÖ tablicƒô 'materials'
            unsubscribe: null, // Subskrypcja nas≈Çuchiwania materia≈Ç√≥w
            viewMode: 'view' // 'view' (lista) lub 'add' (formularz admina)
        };


        const viewContainer = document.getElementById('view-container');
        const authButton = document.getElementById('auth-button');
        const userDisplay = document.getElementById('user-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // --- FUNKCJE POMOCNICZE FIRESTORE ---

        const setLoading = (show, text = '≈Åadowanie...') => {
            loadingText.textContent = text;
            loadingOverlay.classList.toggle('hidden', !show);
        };

        const alertMessage = (message, bgColorClass = 'bg-red-600') => {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${bgColorClass} text-white p-4 rounded-lg shadow-xl z-[999] opacity-0 transition-opacity duration-300`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.classList.add('opacity-100'); }, 10);
            setTimeout(() => { notification.classList.remove('opacity-100'); }, 4000);
            setTimeout(() => { notification.remove(); }, 5000);
        };

        const getUserProfileRef = (uid) => {
            return doc(db, `artifacts/${appId}/users/${uid}/academy_profiles/data`);
        }
        
        const getMaterialsCollectionRef = () => {
            return collection(db, `artifacts/${appId}/public/data/materials`);
        };

        // --- FUNKCJE WYSY≈ÅKI E-MAIL (FORMSPREE) ---

        /**
         * Wysy≈Ça powiadomienie do administratora o nowej rejestracji w celu weryfikacji.
         * U≈ºywa FORMSPREE_ADMIN_NOTIFICATION_URL
         */
        const sendFormspreeAdminNotification = async (userData) => {
            try {
                const response = await fetch(FORMSPREE_ADMIN_NOTIFICATION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        'subject': `[AKADEMIA PISARSTWA] Nowy wniosek o weryfikacjƒô: ${userData.fullName}`,
                        'Imiƒô i Nazwisko': userData.fullName,
                        'Email (do weryfikacji)': userData.email,
                        'Telefon': userData.phone || 'Brak',
                        'Status': userData.verificationStatus,
                        'Komentarz': 'Proszƒô o sprawdzenie i nadanie roli/statusu w konsoli Firebase.'
                    })
                });
                if (!response.ok) {
                    console.error('B≈ÇƒÖd wysy≈Çki powiadomienia do admina (Formspree).', response.statusText);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd po≈ÇƒÖczenia Formspree (admin):', error);
            }
        };

        /**
         * Wysy≈Ça e-mail powitalny do nowo zarejestrowanego u≈ºytkownika z niestandardowym formatowaniem.
         * U≈ºywa FORMSPREE_WELCOME_URL i pola _replyto jako adresu odbiorcy.
         */
        const sendWelcomeEmail = async (userData) => {
            const firstName = userData.fullName.split(' ')[0];
            
            // CA≈ÅA formatowana tre≈õƒá E-MAIL w HTML - TO POLE BƒòDZIE WY≈öWIETLONE PRZEZ FORMSPREE
            const htmlMessage = `
                <div style="font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                    
                    <!-- Nag≈Ç√≥wek E-maila -->
                    <div style="background-color: #059669; color: #ffffff; padding: 20px; text-align: center; border-bottom: 5px solid #10b981;">
                        <h1 style="margin: 0; font-size: 24px;">Akademia Pisemnictwa</h1>
                        <p style="margin: 5px 0 0; font-size: 14px;">Klub Plik√≥w dla Nauczycieli Polskiego</p>
                    </div>

                    <!-- Tre≈õƒá G≈Ç√≥wna -->
                    <div style="padding: 30px; background-color: #ffffff;">
                        <h2 style="color: #10b981; font-size: 22px; margin-top: 0;">Witaj, ${firstName}! Dziƒôkujemy za rejestracjƒô!</h2>
                        
                        <p>Z rado≈õciƒÖ informujemy, ≈ºe Twoje konto zosta≈Ço pomy≈õlnie utworzone. Jeste≈õmy dumni, ≈ºe do≈ÇƒÖczasz do naszej spo≈Çeczno≈õci polonist√≥w!</p>

                        <div style="margin: 20px 0; padding: 15px; border-left: 4px solid #f59e0b; background-color: #fffbeb;">
                            <p style="margin: 0; color: #78350f; font-weight: 600;">Status Twojego konta: WERYFIKACJA W TRAKCIE.</p>
                            <p style="margin: 5px 0 0; font-size: 14px; color: #78350f;">Dostƒôp do Klubu Nauczyciela uzyskasz po weryfikacji, kt√≥ra trwa do 5 dni roboczych.</p>
                        </div>

                        <p>W ka≈ºdej chwili mo≈ºesz sprawdziƒá status swojego konta, logujƒÖc siƒô do Panelu G≈Ç√≥wnego:</p>
                        
                        <!-- Przycisk CTA -->
                        <div style="text-align: center; margin: 30px 0;">
                            <a href="https://twoj-adres-aplikacji.com/dashboard" 
                                style="background-color: #10b981; color: #ffffff; padding: 12px 25px; border-radius: 6px; text-decoration: none; font-weight: bold; display: inline-block;">
                                Przejd≈∫ do Panelu G≈Ç√≥wnego
                            </a>
                        </div>
                        
                        <p>Pozdrawiamy serdecznie,</p>
                        <p style="font-weight: bold; color: #059669;">Zesp√≥≈Ç Akademii Pisemnictwa</p>
                    </div>

                    <!-- Stopka E-maila -->
                    <div style="background-color: #f3f4f6; padding: 20px; text-align: center; font-size: 12px; color: #6b7280;">
                        <p style="margin: 0;">&copy; 2024 Akademia Pisemnictwa. Wszelkie prawa zastrze≈ºone.</p>
                        <p style="margin: 5px 0 0;">Otrzyma≈Çe≈õ tƒô wiadomo≈õƒá, poniewa≈º zarejestrowa≈Çe≈õ siƒô w naszym systemie.</p>
                    </div>
                </div>
            `;

            try {
                // Wywo≈Çanie Formspree
                const response = await fetch(FORMSPREE_WELCOME_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Ten nag≈Ç√≥wek m√≥wi Formspree, aby wys≈Ça≈Ç wiadomo≈õƒá na ten adres
                        '_replyto': userData.email, 
                        // To jest tytu≈Ç maila
                        'subject': `Witaj w Akademii Pisemnictwa, ${firstName}!`,
                        // To jest formatowana tre≈õƒá HTML
                        'message': htmlMessage, 
                        'Imiƒô': firstName
                    })
                });
                
                if (!response.ok) {
                    console.error('B≈ÇƒÖd wysy≈Çki wiadomo≈õci powitalnej (Formspree).', response.statusText);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd po≈ÇƒÖczenia Formspree (powitalny):', error);
            }
        };


        // --- NAS≈ÅUCHIWANIE I INICJALIZACJA ---

        const listenToMaterials = () => {
            if (materialState.unsubscribe) {
                materialState.unsubscribe(); // Czy≈õci starƒÖ subskrypcjƒô
            }

            // Ustawia nas≈Çuchiwanie na publicznƒÖ kolekcjƒô materia≈Ç√≥w
            const q = query(getMaterialsCollectionRef());
            
            materialState.unsubscribe = onSnapshot(q, (snapshot) => {
                const materialsList = [];
                snapshot.forEach((doc) => {
                    materialsList.push({ id: doc.id, ...doc.data() });
                });
                
                // Sortowanie materia≈Ç√≥w po klasie
                materialsList.sort((a, b) => a.classLevel - b.classLevel); 
                materialState.allMaterials = materialsList;
                
                // Od≈õwie≈ºenie widoku Klubu Nauczyciela, je≈õli jest aktywny
                if (currentView === 'filesClub' && materialState.viewMode === 'view') {
                    renderFilesClubViewContent();
                }
            }, (error) => {
                console.error("B≈ÇƒÖd nas≈Çuchiwania materia≈Ç√≥w:", error);
            });
        };

        const setupFirebase = async () => {
            navigateTo('home');
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autoryzacja
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Nas≈Çuchiwanie stanu autoryzacji
                onAuthStateChanged(auth, (user) => {
                    userId = user ? user.uid : null;
                    isAuthReady = true;
                    if (user && user.email) {
                        listenToUserProfile(user.uid);
                        listenToMaterials(); // Rozpocznij nas≈Çuchiwanie materia≈Ç√≥w
                    } else {
                        userProfile = null;
                        updateAuthUI(user);
                        if (currentView !== 'home') {
                            navigateTo('home');
                        }
                    }
                });

            } catch (error) {
                console.error("B≈ÇƒÖd inicjalizacji Firebase:", error);
                setLoading(false);
                alertMessage(`B≈ÇƒÖd inicjalizacji: ${error.message}. Sprawd≈∫ konfiguracjƒô Firebase.`);
            }
        };

        const listenToUserProfile = (uid) => {
            const profileRef = getUserProfileRef(uid);
            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    checkVerificationStatus(false);
                } else {
                    userProfile = null;
                    if (auth.currentUser && !auth.currentUser.isAnonymous) {
                         navigateTo('home');
                    } else {
                        navigateTo('home');
                    }
                }
                updateAuthUI(auth.currentUser);
                setLoading(false);
            }, (error) => {
                console.error("B≈ÇƒÖd nas≈Çuchiwania Firestore:", error);
                setLoading(false);
            });
        };

        const checkVerificationStatus = (isFilesClubAttempt = false) => {
            if (!auth.currentUser || !userProfile) {
                navigateTo('home');
                return;
            }

            const status = userProfile?.verificationStatus;

            if (status === 'verified') {
                navigateTo('filesClub');
            } else if (status === 'pending' || status === 'false' || !userProfile) { 
                if (isFilesClubAttempt) {
                    alertMessage("Dostƒôp do Klubu Nauczyciela wymaga pomy≈õlnej weryfikacji konta. Sprawd≈∫ status w Panelu G≈Ç√≥wnym.");
                }
                navigateTo('dashboard');
            } else {
                navigateTo('home');
            }
        };

        const updateAuthUI = (user) => {
            const dashboardLink = document.getElementById('dashboard-link');
            const filesLink = document.getElementById('files-link');

            if (user && userProfile) {
                authButton.textContent = 'Wyloguj';
                authButton.onclick = signOutUser;
                userDisplay.textContent = `Witaj, ${userProfile.fullName.split(' ')[0]}!`;
                userDisplay.classList.remove('hidden');
                
                dashboardLink.classList.remove('hidden');
                filesLink.classList.remove('hidden');
            } else {
                authButton.textContent = 'Zaloguj siƒô';
                authButton.onclick = () => navigateTo('auth');
                userDisplay.classList.add('hidden');
                userDisplay.textContent = '';
                
                if (dashboardLink) dashboardLink.classList.add('hidden');
                if (filesLink) filesLink.classList.add('hidden');
            }
        };

        const handleAuthClick = () => {
            if (auth.currentUser && userProfile) {
                signOutUser();
            } else {
                navigateTo('auth');
            }
        };

        // --- OBS≈ÅUGA FORMULARZY ---
        
        const handleAuthFormSubmit = (event) => {
            event.preventDefault();
            const form = event.target;
            const isRegister = form.querySelector('#fullName') !== null;
            
            if (isRegister) {
                const fullName = form.querySelector('#fullName').value.trim();
                const email = form.querySelector('#email').value.trim();
                const phone = form.querySelector('#phone').value.trim();
                const password = form.querySelector('#password').value;
                const confirmPassword = form.querySelector('#confirmPassword').value;

                if (password !== confirmPassword) {
                    alertMessage('Has≈Ça nie sƒÖ identyczne!');
                    return;
                }
                registerUser(fullName, email, phone, password);
            } else {
                const email = form.querySelector('#loginEmail').value.trim();
                const password = form.querySelector('#loginPassword').value;
                signInUser(email, password);
            }
        };

        const registerUser = async (fullName, email, phone, password) => {
            setLoading(true, 'Rejestrowanie u≈ºytkownika...');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                
                const userData = {
                    fullName: fullName,
                    email: email,
                    phone: phone,
                    verificationStatus: 'pending', 
                    role: 'USER', // Domy≈õlna rola
                };
                
                // 1. Zapis profilu w Firestore
                await setDoc(getUserProfileRef(uid), userData);

                // 2. Wysy≈Çanie maila/powiadomienia o nowym u≈ºytkowniku do administratora
                await sendFormspreeAdminNotification(userData); 

                // 3. Wysy≈Çanie maila powitalnego do u≈ºytkownika
                await sendWelcomeEmail(userData); 

                alertMessage('Rejestracja udana! Sprawd≈∫ skrzynkƒô odbiorczƒÖ.', 'bg-emerald-600');
                navigateTo('verificationStatusCheck');
            } catch (error) {
                console.error("B≈ÇƒÖd rejestracji:", error);
                alertMessage(`B≈ÇƒÖd rejestracji: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        const signInUser = async (email, password) => {
            setLoading(true, 'Logowanie...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                alertMessage('Zalogowano pomy≈õlnie!', 'bg-emerald-600');
                // navigateTo() jest obs≈Çugiwane przez onAuthStateChanged/listenToUserProfile
            } catch (error) {
                console.error("B≈ÇƒÖd logowania:", error);
                alertMessage(`B≈ÇƒÖd logowania: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        const signOutUser = async () => {
            setLoading(true, 'Wylogowywanie...');
            try {
                await signOut(auth);
                userProfile = null;
                alertMessage('Wylogowano pomy≈õlnie.', 'bg-emerald-600');
                navigateTo('home');
            } catch (error) {
                console.error("B≈ÇƒÖd wylogowania:", error);
                alertMessage(`B≈ÇƒÖd wylogowania: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };
        
        const handleAddMaterialSubmit = async (event) => {
            event.preventDefault();
            setLoading(true, 'Zapisywanie materia≈Çu...');

            const form = event.target;
            const newMaterial = {
                title: form.querySelector('#materialTitle').value.trim(),
                description: form.querySelector('#materialDescription').value.trim(),
                classLevel: parseInt(form.querySelector('#materialClassLevel').value, 10),
                type: form.querySelector('#materialType').value.trim(),
                size: form.querySelector('#materialSize').value.trim(),
                url: form.querySelector('#materialUrl').value.trim(),
                createdAt: new Date().toISOString(),
                author: userProfile?.fullName || 'Admin',
            };

            try {
                await addDoc(getMaterialsCollectionRef(), newMaterial);
                alertMessage('Materia≈Ç dodany pomy≈õlnie!', 'bg-emerald-600');
                materialState.viewMode = 'view';
                navigateTo('filesClub');
            } catch (error) {
                console.error("B≈ÇƒÖd dodawania materia≈Çu:", error);
                alertMessage(`B≈ÇƒÖd zapisu: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };


        // --- WIDOKI ---

        window.navigateTo = (view) => {
            currentView = view;
            render();
            window.scrollTo(0, 0);
        };
        
        window.setFilterClass = (classLevel) => {
            selectedClass = classLevel;
            renderFilesClubViewContent();
        }
        
        window.toggleAdminView = (mode) => {
            materialState.viewMode = mode;
            navigateTo('filesClub'); // Wymu≈õ ponowne renderowanie
        };

        window.switchAuthMode = (isRegister) => {
            viewContainer.innerHTML = renderAuthView(isRegister);
            document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
        };

        const renderHomeView = () => `
            <div class="hero-bg text-white p-12 md:p-20 rounded-xl shadow-2xl text-center">
                <h1 class="text-4xl md:text-6xl font-extrabold mb-4">Akademia Pisemnictwa</h1>
                <p class="text-xl md:text-2xl mb-8 font-light">Twoje ≈∫r√≥d≈Ço profesjonalnych materia≈Ç√≥w do nauki pisania wypracowa≈Ñ.</p>
                
                <p class="text-lg mb-10 font-medium text-emerald-100 max-w-2xl mx-auto">
                    Akademia Pisemnictwa to platforma stworzona z my≈õlƒÖ o <b>nauczycielach jƒôzyka polskiego</b>. Dostarczamy gotowe, sprawdzone materia≈Çy dydaktyczne, w tym <b>checklisty i szablony</b>, kt√≥re u≈ÇatwiajƒÖ weryfikacjƒô wiedzy i umiejƒôtno≈õci pisarskich uczni√≥w.
                </p>

                <button onclick="navigateTo('auth')" class="bg-white text-emerald-600 font-bold py-3 px-8 rounded-full text-lg uppercase tracking-wider btn-primary">
                    Do≈ÇƒÖcz do Klubu Plik√≥w
                </button>
            </div>

            <div class="grid md:grid-cols-3 gap-8 mt-12">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-500">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Baza Wypracowa≈Ñ</h3>
                    <p class="text-gray-600">Gotowe szablony i analizy lektur, dostosowane do wymaga≈Ñ egzaminacyjnych.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-500">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Checklisty Oceniania</h3>
                    <p class="text-gray-600">Dok≈Çadne listy kontrolne dla nauczycieli i uczni√≥w, u≈ÇatwiajƒÖce sprawdzanie prac.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-500">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Webinary i Kursy</h3>
                    <p class="text-gray-600">Dostƒôp do archiwalnych nagra≈Ñ z warsztat√≥w dla polonist√≥w.</p>
                </div>
            </div>
        `;

        const renderAuthView = (isRegister = false) => `
            <div id="auth-card" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">${isRegister ? 'Zarejestruj siƒô' : 'Zaloguj siƒô'}</h2>
                <form id="auth-form">
                    ${isRegister ? `
                        <input type="text" id="fullName" placeholder="Imiƒô i nazwisko" required class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="email" id="email" placeholder="E-mail" required class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="tel" id="phone" placeholder="Numer telefonu (opcjonalnie)" class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="password" id="password" placeholder="Has≈Ço" required class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="password" id="confirmPassword" placeholder="Powt√≥rz has≈Ço" required class="input-field w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none"/>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg btn-primary shadow-md">
                            Zarejestruj i Popro≈õ o Weryfikacjƒô
                        </button>
                    ` : `
                        <input type="email" id="loginEmail" placeholder="E-mail" required class="input-field w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none"/>
                        <input type="password" id="loginPassword" placeholder="Has≈Ço" required class="input-field w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none"/>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg btn-primary shadow-md">
                            Zaloguj siƒô
                        </button>
                    `}
                </form>
                <div class="mt-6 text-center">
                    ${isRegister ? `
                        <p class="text-sm text-gray-600">Masz ju≈º konto? <a href="#" onclick="switchAuthMode(false)" class="text-emerald-600 hover:text-emerald-700 font-semibold">Zaloguj siƒô</a></p>
                    ` : `
                        <p class="text-sm text-gray-600">Nie masz konta? <a href="#" onclick="switchAuthMode(true)" class="text-emerald-600 hover:text-emerald-700 font-semibold">Zarejestruj siƒô</a></p>
                    `}
                </div>
            </div>
        `;

        const renderDashboardView = () => {
            const userName = userProfile ? userProfile.fullName.split(' ')[0] : 'U≈ºytkowniku';
            const status = userProfile?.verificationStatus;
            
            let statusMessageHtml;
            let statusClass = "border-emerald-600";

            if (status === 'verified') {
                statusMessageHtml = `
                    <p class="text-lg text-gray-600 mb-8">Jak Ci mija dzisiejszy dzie≈Ñ? Twoje konto jest <b>ZWERYFIKOWANE</b>. Pe≈Çen dostƒôp do Klubu Nauczyciela czeka!</p>
                    <button onclick="navigateTo('filesClub')" class="mt-6 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-6 rounded-lg btn-primary shadow-md">
                        Przejd≈∫ do Klubu Nauczyciela
                    </button>
                `;
            } else if (status === 'false') {
                statusClass = "border-red-600";
                statusMessageHtml = `
                    <h3 class="text-2xl font-bold mb-4 text-red-600">Twoje konto nie zosta≈Ço zweryfikowane</h3>
                    <p class="text-gray-700 font-medium mb-4">Skontaktuj siƒô z nami w celu wyja≈õnienia statusu.</p>
                    <div class="text-left bg-red-50 p-6 rounded-lg border border-red-200">
                        <p class="font-semibold text-gray-800 mt-4 mb-2">Skontaktuj siƒô z nami:</p>
                        <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                            <li><span class="font-medium text-red-600">Sprawy weryfikacji konta:</span> <a href="mailto:weryfikacja.osc4r@hub.pl" class="text-blue-600 hover:underline">weryfikacja.osc4r@hub.pl</a></li>
                            <li><span class="font-medium text-red-600">Inne zapytania:</span> <a href="mailto:centrumobslugiklienta@osc4r.hub.pl" class="text-blue-600 hover:underline">centrumobslugiklienta@osc4r.hub.pl</a></li>
                        </ul>
                        <p class="mt-4 text-sm text-gray-500">Odpowiemy w ciƒÖgu 5 dni roboczych.</p>
                    </div>
                `;
            } else { 
                statusClass = "border-yellow-500";
                statusMessageHtml = `
                    <h3 class="text-2xl font-bold mb-4 text-yellow-600">Twoje konto jest w trakcie weryfikacji</h3>
                    <p class="text-lg text-gray-600 mb-8">Jak Ci mija dzisiejszy dzie≈Ñ? Czekamy na potwierdzenie Twoich danych.</p>
                    <p class="text-gray-500">Dostƒôp do Klubu Nauczyciela uzyskasz po zako≈Ñczeniu weryfikacji (do 5 dni roboczych).</p>
                `;
            }

            return `
                <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 ${statusClass} text-center">
                    <h2 class="text-4xl font-bold mb-4 text-gray-800">Witaj, ${userName}!</h2>
                    ${statusMessageHtml}
                </div>
            `;
        };

        const renderVerificationStatusView = () => {
            const userName = userProfile ? userProfile.fullName.split(' ')[0] : 'U≈ºytkowniku';
            
            return `
                <div class="max-w-xl mx-auto bg-white p-10 rounded-xl shadow-2xl border-l-4 border-yellow-500 text-center">
                    <svg class="w-16 h-16 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">Wniosek Wys≈Çany</h2>
                    <p class="text-gray-600 mb-6 text-lg">Witaj, <b>${userName}</b>!</p>
                    
                    <div class="text-left bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                        <p class="text-gray-700 mb-4">Tw√≥j wniosek o weryfikacjƒô konta zosta≈Ç przyjƒôty. Proces ten potrwa do <b>5 dni roboczych</b>.</p>
                        <p class="text-gray-700 font-medium"><b>Sprawd≈∫ te≈º swojƒÖ skrzynkƒô mailowƒÖ</b> ‚Äî wys≈Çali≈õmy Ci wiadomo≈õƒá powitalnƒÖ. Dostƒôp do Klubu Nauczyciela uzyskasz po zako≈Ñczeniu weryfikacji. Wr√≥ƒá do <a href="#" onclick="navigateTo('dashboard')" class="text-emerald-600 hover:underline font-semibold">Panelu G≈Ç√≥wnego</a>, aby sprawdziƒá status.</p>
                    </div>

                    <button onclick="signOutUser()" class="mt-8 text-sm text-red-500 hover:text-red-700 transition">Wyloguj</button>
                </div>
            `;
        };
        
        const renderFilesClubViewContent = () => {
            // U≈ºycie dynamicznie ≈Çadowanych materia≈Ç√≥w z Firestore
            const filteredMaterials = materialState.allMaterials.filter(m => m.classLevel === selectedClass);
            
            const classButtons = [4, 5, 6, 7, 8].map(cls => `
                <button 
                    onclick="setFilterClass(${cls})" 
                    class="py-2 px-4 rounded-full font-semibold transition duration-150 ease-in-out ${selectedClass === cls ? 'bg-emerald-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-emerald-100'}"
                >
                    Klasa ${cls}
                </button>
            `).join('');

            const materialsHtml = filteredMaterials.length > 0 ? filteredMaterials.map(m => `
                <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 hover:shadow-lg transition duration-150">
                    <h3 class="text-2xl font-semibold mb-2 text-gray-800">${m.title}</h3>
                    <p class="text-gray-600 mb-3">${m.description}</p>
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span>Typ: <b>${m.type}</b></span>
                        <span>Rozmiar: <b>${m.size}</b></span>
                    </div>
                    <a href="${m.url}" target="_blank" rel="noopener noreferrer" class="mt-3 inline-block text-emerald-600 font-medium hover:underline">Pobierz Materia≈Ç</a>
                </div>
            `).join('') : `<p class="col-span-full text-center text-gray-500 py-10">Brak materia≈Ç√≥w dla wybranej klasy. Pracujemy nad ich dodaniem!</p>`;

            const classFiltersElement = document.getElementById('class-filters');
            if (classFiltersElement) {
                classFiltersElement.innerHTML = classButtons;
            }
            const materialsListElement = document.getElementById('materials-list');
            if (materialsListElement) {
                materialsListElement.innerHTML = materialsHtml;
            }
        };

        const renderAddMaterialForm = () => {
            return `
                <div class="max-w-xl mx-auto bg-gray-50 p-8 rounded-xl shadow-lg border-t-4 border-indigo-600">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-3xl font-bold text-indigo-700">Dodaj Nowy Materia≈Ç (ADMIN)</h3>
                        <button onclick="toggleAdminView('view')" class="text-sm text-gray-500 hover:text-gray-700 flex items-center">
                             <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Wr√≥ƒá do listy
                        </button>
                    </div>
                    <p class="text-gray-600 mb-6">Wprowad≈∫ szczeg√≥≈Çy nowego pliku, kt√≥ry bƒôdzie dostƒôpny dla zweryfikowanych nauczycieli. Upewnij siƒô, ≈ºe URL jest poprawny.</p>
                    
                    <form id="add-material-form">
                        <div class="mb-4">
                            <label for="materialTitle" class="block text-sm font-medium text-gray-700 mb-1">Tytu≈Ç Materia≈Çu</label>
                            <input type="text" id="materialTitle" required class="input-field w-full p-3 border border-gray-300 rounded-lg focus:outline-none"/>
                        </div>
                        <div class="mb-4">
                            <label for="materialDescription" class="block text-sm font-medium text-gray-700 mb-1">Opis</label>
                            <textarea id="materialDescription" required rows="3" class="input-field w-full p-3 border border-gray-300 rounded-lg focus:outline-none"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="materialClassLevel" class="block text-sm font-medium text-gray-700 mb-1">Klasa</label>
                                <select id="materialClassLevel" required class="input-field w-full p-3 border border-gray-300 rounded-lg focus:outline-none">
                                    <option value="4">Klasa 4</option>
                                    <option value="5">Klasa 5</option>
                                    <option value="6">Klasa 6</option>
                                    <option value="7">Klasa 7</option>
                                    <option value="8">Klasa 8</option>
                                </select>
                            </div>
                            <div>
                                <label for="materialType" class="block text-sm font-medium text-gray-700 mb-1">Typ Pliku</label>
                                <select id="materialType" required class="input-field w-full p-3 border border-gray-300 rounded-lg focus:outline-none">
                                    <option value="PDF">PDF</option>
                                    <option value="DOCX">DOCX</option>
                                    <option value="Arkusz Google">Arkusz Google</option>
                                    <option value="Wideo">Wideo</option>
                                    <option value="Inny">Inny</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="materialSize" class="block text-sm font-medium text-gray-700 mb-1">Rozmiar (np. '1.5 MB', 'Online')</label>
                                <input type="text" id="materialSize" required class="input-field w-full p-3 border border-gray-300 rounded-lg focus:outline-none"/>
                            </div>
                            <div>
                                <label for="materialUrl" class="block text-sm font-medium text-gray-700 mb-1">Link do Pliku (URL)</label>
                                <input type="url" id="materialUrl" required class="input-field w-full p-3 border border-gray-300 rounded-lg focus:outline-none"/>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg btn-primary shadow-md">
                            Zapisz Materia≈Ç w Bazie Firestore
                        </button>
                    </form>
                </div>
            `;
        };

        const renderFilesClubView = () => {
            if (!userProfile || userProfile.verificationStatus !== 'verified') {
                checkVerificationStatus(true);
                return '';
            }
            
            const isAdmin = userProfile.role === 'ADMIN';

            if (materialState.viewMode === 'add' && isAdmin) {
                return renderAddMaterialForm();
            }
            
            // Widok listy materia≈Ç√≥w
            return `
                <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-emerald-600">
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-4xl font-bold text-emerald-700">üèÜ Klub Nauczyciela - Materia≈Çy Dydaktyczne</h2>
                        ${isAdmin ? `
                            <button onclick="toggleAdminView('add')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center whitespace-nowrap">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Dodaj Materia≈Ç
                            </button>
                        ` : ''}
                    </div>
                    <p class="text-lg text-gray-700 mb-8">Poni≈ºej znajdziesz materia≈Çy pogrupowane wed≈Çug klas 4-8. Wybierz klasƒô, aby filtrowaƒá zasoby. Obecnie widzisz <b>${materialState.allMaterials.length}</b> materia≈Ç√≥w w systemie.</p>

                    <div id="class-filters" class="flex flex-wrap gap-3 mb-8">
                    </div>

                    <div id="materials-list" class="grid md:grid-cols-2 gap-6">
                        <!-- Materia≈Çy ≈Çadowane przez renderFilesClubViewContent -->
                    </div>
                    ${materialState.allMaterials.length === 0 ? `<div class="text-center py-10 text-gray-500 italic">Brak materia≈Ç√≥w w bazie. Administratorze, dodaj pierwszy plik!</div>` : ''}
                </div>
            `;
        };


        const render = () => {
            viewContainer.style.opacity = '0';
            viewContainer.style.transform = 'perspective(1000px) translateY(20px) scale(0.98)';
            
            let htmlContent;
            switch (currentView) {
                case 'home': htmlContent = renderHomeView(); break;
                case 'auth': htmlContent = renderAuthView(false); break;
                case 'dashboard': htmlContent = renderDashboardView(); break;
                case 'verificationStatusCheck': htmlContent = renderVerificationStatusView(); break;
                case 'filesClub': htmlContent = renderFilesClubView(); break;
                default: htmlContent = renderHomeView();
            }
            viewContainer.innerHTML = htmlContent;
            
            setTimeout(() => {
                viewContainer.style.opacity = '1';
                viewContainer.style.transform = 'perspective(1000px) translateY(0) scale(1)';
                
                if (currentView === 'auth') {
                    document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
                } else if (currentView === 'filesClub' && userProfile?.verificationStatus === 'verified') {
                    if (materialState.viewMode === 'view') {
                        renderFilesClubViewContent();
                    } else if (materialState.viewMode === 'add') {
                        document.getElementById('add-material-form').addEventListener('submit', handleAddMaterialSubmit);
                    }
                }
            }, 600);
        };

        // --- INICJALIZACJA ---
        setupFirebase();

    </script>
</body>
</html>
